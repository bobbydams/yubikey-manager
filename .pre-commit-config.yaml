# Pre-commit hooks configuration for YubiKey GPG Manager
# See https://pre-commit.com for more information
# Install with: pip install pre-commit && pre-commit install

default_stages: [pre-commit]

repos:
  # General file checks
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      - id: trailing-whitespace
        args: [--markdown-linebreak-ext=md]
      - id: end-of-file-fixer
      - id: check-yaml
        args: [--unsafe] # Allow custom YAML tags
      - id: check-added-large-files
        args: ["--maxkb=1000"]
      - id: check-merge-conflict
      - id: detect-private-key
      - id: check-case-conflict
      - id: mixed-line-ending
        args: [--fix=lf]

  # Local hooks for Go testing and linting
  - repo: local
    hooks:
      - id: go-fmt
        name: go fmt
        description: Run gofmt on Go files
        entry: bash -c 'cd "$(git rev-parse --show-toplevel)" && gofmt -w -s "$@"' --
        language: system
        types: [go]
        pass_filenames: true

      - id: go-imports
        name: go imports
        description: Run goimports on Go files
        entry: bash -c 'command -v goimports >/dev/null 2>&1 && cd "$(git rev-parse --show-toplevel)" && goimports -w "$@" || exit 0' --
        language: system
        types: [go]
        pass_filenames: true

      - id: go-vet
        name: go vet
        description: Run go vet on Go files
        entry: bash -c 'cd "$(git rev-parse --show-toplevel)" && go vet ./...'
        language: system
        pass_filenames: false
        types: [go]

      - id: go-mod-tidy
        name: go mod tidy
        description: Run go mod tidy and check for changes
        entry: bash -c 'cd "$(git rev-parse --show-toplevel)" && go mod tidy && git diff --exit-code go.mod go.sum || (echo "go mod tidy made changes" && exit 1)'
        language: system
        files: ^go\.(mod|sum)$
        pass_filenames: false

      - id: go-test
        name: go test
        description: Run Go tests
        entry: bash -c 'cd "$(git rev-parse --show-toplevel)" && go test ./... -v -short'
        language: system
        pass_filenames: false
        types: [go]

      - id: go-build
        name: go build
        description: Verify Go code compiles
        entry: bash -c 'cd "$(git rev-parse --show-toplevel)" && go build -trimpath ./...'
        language: system
        pass_filenames: false
        types: [go]

      - id: golangci-lint
        name: golangci-lint
        description: Run golangci-lint for comprehensive linting
        entry: bash -c 'if command -v golangci-lint >/dev/null 2>&1; then cd "$(git rev-parse --show-toplevel)" && golangci-lint run --fix; else echo "golangci-lint not installed, skipping..." && exit 0; fi'
        language: system
        pass_filenames: false
        types: [go]
        # Only run if golangci-lint is installed
        # Install with: go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest

  # Shell script linting (for any shell scripts in the repo)
  - repo: https://github.com/shellcheck-py/shellcheck-py
    rev: v0.11.0.1
    hooks:
      - id: shellcheck
        args: [--severity=warning]
        exclude: ^test/

# Configuration for CI environments
ci:
  autofix_commit_msg: |
    [pre-commit.ci] auto fixes from pre-commit hooks

    for more information, see https://pre-commit.ci
  autofix_prs: true
  autoupdate_branch: ""
  autoupdate_commit_msg: "[pre-commit.ci] pre-commit autoupdate"
  autoupdate_schedule: weekly
  skip: [go-test, go-build, golangci-lint] # These require Go installed
  submodules: false
